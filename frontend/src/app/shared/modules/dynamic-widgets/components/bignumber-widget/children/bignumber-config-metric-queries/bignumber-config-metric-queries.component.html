<!-- list of metric-items -->
<div class="query-metrics-section">
    <div class="query-metrics-wrap">
        <mat-accordion class="query-group-list mat-elevation-z0" [ngClass]="{'items-selected': selectAllToggle !== 'none'}" displayMode="flat" [multi]="true" [hideToggle]="false">
            <mat-expansion-panel class="query-group-item mat-elevation-z0" [hideToggle]="true "[disabled]="true" [expanded]="true" *ngFor="let group of widget.query.groups; let gIndex=index">
                
                <mat-expansion-panel-header [collapsedHeight]="30" [expandedHeight]="30">
                    <mat-toolbar class="group-item-toolbar">
                        <span class="toolbar-item group-label">
                        </span>
                        <span class="flex-spacer"></span>
                        <span class="toolbar-item add-query-actions">
                            <mat-icon fontSet="denali" fontIcon="d-add"></mat-icon>
                            <span>Add:&nbsp;</span>
                            <button mat-button color="primary" (click)="openTimeSeriesMetricDialog(group.id); $event.stopPropagation()" >Query</button>
                            <button mat-button color="primary" (click)="openMetricExpressionDialog(group); $event.stopPropagation()">Expression</button>
                        </span>
                        <span class="toolbar-action-icons">
                        </span>
                    </mat-toolbar>
                </mat-expansion-panel-header>

                <div class="query-metric-row" *ngFor="let query of group.queries; let index=index">
                    <span class="enabled-metric-radio-button">
                        <mat-radio-button class="query-metric-row" [checked]="this.widget.query.settings.visual.queryID == index" (change)="querySelected(index)"></mat-radio-button>
                    </span>
                    <div class="query-metric-item">
                        <div class="metric-detail">
                            <span class="detail-item" *ngIf="query.metric">{{ query.metric }}</span>
                            <span class="expression" *ngIf="query.expression">
                                <span class="expression-collapse">
                                        <button mat-icon-button [disableRipple]="true" (click)="toggleExpressionCollapsed(query, group, $event)">
                                        <mat-icon fontSet="denali" *ngIf="query.settings.expanded" fontIcon="d-arrowhead-down" class="arrow-down"></mat-icon>
                                        <mat-icon fontSet="denali" *ngIf="!query.settings.expanded" fontIcon="d-arrowhead-right" class="arrow-right"></mat-icon>
                                    </button>
                                </span>
                                <span class="expression-detail">
                                    {{ query.settings.visual.label }} {{ query.expression }}
                                </span>
                            </span>

                            <span class="flex-spacer"></span>
                            <span class="action-icons">
                                <button mat-icon-button color="primary" (click)="deleteQuery(index)">
                                    <mat-icon fontSet="denali" fontIcon="d-trash"></mat-icon>
                                </button>
                            </span>
                        </div>

                        <div class="metric-tags">
                            <strong>Tags:</strong>
                            <mat-chip-list>
                                <mat-basic-chip *ngFor="let tag of query.filters"><span>{{ tag.tagk }}:</span> <strong>{{ tag.filter }}</strong></mat-basic-chip>
                            </mat-chip-list>
                        </div>

                        <div class="expression-metrics" *ngIf="query.settings.expanded">
                            <div class="metric" *ngFor="let emetric of query.metrics">
                                <div class="metric-alias">
                                        <span>{{ emetric.id }}</span>
                                </div>
                                <div class="metric-label">{{ emetric.metric }}</div>
                            </div>
                        </div>
                    </div>
                </div>

            </mat-expansion-panel>
        </mat-accordion>
    </div>
</div>    

<!-- <mat-toolbar class="config-toolbar time-series-toolbar">
    <mat-toolbar-row>
        <div class="toolbar-item">
            <button class="mat-elevation-z0" mat-stroked-button color="primary"  (click)="openTimeSeriesMetricDialog()">
                <mat-icon fontSet="denali" fontIcon="d-add"></mat-icon>
                <span>Add Query</span>
            </button>
        </div>
    </mat-toolbar-row>
</mat-toolbar>
<div class="query-metrics-section" *ngIf="widget.query.groups.length !== 0">
    <mat-list>
        <ng-container *ngFor="let query of widget.query.groups[0].queries;let index=index">
            <mat-list-item class="query-metric-item">
                <mat-toolbar class="query-metric-toolbar">
                    <span class="enabled-metric-radio-button">
                        <mat-radio-button class="query-metric-row" [checked]="this.widget.query.settings.visual.queryID == index" (change)="querySelected(index)"></mat-radio-button>
                    </span>
                    <strong>
                        {{query.metric}}
                    </strong>
                    <div class="minutiae">
                        <span>
                            <mat-icon fontSet="denali" fontIcon="d-time"></mat-icon> Time aggregator: {{ query.downsample }}
                        </span>
                        <span>Tag aggregator: {{ query.settings.visual.aggregator }}</span>
                        <span>Counter: {{ query.counter ? 'ON' : 'OFF' }}</span>
                        <span>Rate: {{ query.rate ? 'ON' : 'OFF' }}</span>
                    </div>
                    <span class="flex-spacer"></span>
                    <div class="action-icons">
                        <button mat-icon-button color="primary" (click)="deleteQuery(index)">
                            <mat-icon fontSet="denali" fontIcon="d-trash"></mat-icon>
                        </button>
                    </div>
                </mat-toolbar>
                <div class="modifier-row">
                    <div class="modifier-item metric-aggregator">
                        <strong>Value:</strong>
                        <dropdown-aggregators 
                            [value]="query.settings.visual.aggregator"
                            (change)="setVisualization('aggregator', index, $event)">
                        </dropdown-aggregators>
                    </div>                   
                </div>
                <div class="tags-row">
                    <strong>Tags:</strong>
                    <mat-chip-list>
                        <mat-basic-chip class="tag-chip" [disableRipple]="true" *ngFor="let tag of query.filters">
                            <span class="tag-key">{{ tag.tagk }}:</span>
                            <strong class="tag-value">{{ tag.filter }}</strong>
                            <button mat-mini-fab class="remove-tag">
                                <mat-icon fontSet="denali" fontIcon="d-close"></mat-icon>
                            </button>
                        </mat-basic-chip>
                        <mat-basic-chip class="tag-chip" [disableRipple]="true">
                            <span class="tag-key">someTagKey:</span>
                            <strong class="tag-value">someTagValue</strong>
                            <button mat-mini-fab class="remove-tag">
                                <mat-icon fontSet="denali" fontIcon="d-close"></mat-icon>
                            </button>
                        </mat-basic-chip>
                        <mat-basic-chip class="tag-chip" [disableRipple]="true">
                            <span class="tag-key">someTagKey:</span>
                            <strong class="tag-value">someTagValue</strong>
                            <button mat-mini-fab class="remove-tag">
                                <mat-icon fontSet="denali" fontIcon="d-close"></mat-icon>
                            </button>
                        </mat-basic-chip>
                        <!-- TODO: add mechanism to add a tag filter --
                        <mat-basic-chip class="add-tag-filter-button">
                            <button mat-icon-button color="primary">
                                <mat-icon fontSet="denali" fontIcon="d-add-square"></mat-icon>
                            </button>
                        </mat-basic-chip>
                    </mat-chip-list>
                </div>
            </mat-list-item>
            <mat-divider></mat-divider>
        </ng-container>
    </mat-list>
</div> -->
