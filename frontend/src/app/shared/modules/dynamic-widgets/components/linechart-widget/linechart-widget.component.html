<div class="widget-output-container" #widgetOutputContainer fxLayout="column">
    <div class="widget-title" #widgetTitle *ngIf="editMode" fxLayout="row" fxFlex="1 0 30px">
        <span fxFlex="1 1 100%">{{ widget.settings.title }}</span>
        <span>
            <button mat-button color="primary" class="close-edit-view-btn" (click)="closeViewEditMode()">
                <mat-icon fontSet="denali" fontIcon="d-close"></mat-icon>
            </button>
        </span>
    </div>
    <div class="widget-output" #widgetoutput
        [ngClass]="{
            'display-legend-top': widget.settings.legend.display && widget.settings.legend.position=='top' && options.labels.length > 1,
            'display-legend-right': widget.settings.legend.display && widget.settings.legend.position=='right' && options.labels.length > 1,
            'display-legend-bottom': widget.settings.legend.display && widget.settings.legend.position=='bottom' && options.labels.length > 1,
            'display-legend-left': widget.settings.legend.display && widget.settings.legend.position=='left' && options.labels.length > 1
        }">
        <!-- STANDARD GRAPH OUTPUT -->
        <div class="multigraph-output">
            <div class="multi-graph-container" #multigraphContainer [ngClass]="{'multigraph-grid-mode': multigraphMode === 'grid', 'multigraph-freeflow-mode': !multigraphEnabled || multigraphMode === 'freeflow'}" (scroll)="multigraphContainerScroll($event)">
                <!-- column headers -->
                <div class="graph-header-row" #multigraphHeaderRow *ngIf="multigraphColumns.length > 0">
                    <div class="graph-header-cell" *ngFor="let columnName of multigraphColumns" [style.width.px]="size.width">
                        <span>{{columnName}}</span>
                    </div>
                </div>
                <!-- graphs -->
                <div class="graph-row" *ngFor="let yKey of getGraphDataObjectKeys(graphData); let i = index;">
                    <div class="graph-cell" *ngFor="let xKey of getGraphDataObjectKeys(graphData[yKey]); let j = index;" [style.width.px]="size.width" [style.height.px]="size.height">
                        <!--grid-cell-[{{i}},{{j}}]
                        <ng-container *ngTemplateOutlet="graphRender;context:(getGraphTemplateContext(graphData[yKey][xKey],{yKey:yKey,xKey:xKey,yIdx:i,xIdx:j}))"></ng-container>-->
                        <div>
                            <div #dygraph class="graph-chart" [ngClass]="{'hide': widget.settings.legend.display &&  ( size.width <= 10 || size.height <= 10 ) }"
                                dygraphsChart
                                [chartType]="chartType"
                                [data]="graphData[yKey][xKey]"
                                [size]="size"
                                [options]="graphData[yKey][xKey].options"
                                [eventBuckets]="buckets"
                                [showEvents]="widget.settings.visual.showEvents"
                                [renderReady]="false"
                                [multigraph]="multigraphEnabled"
                                (dateWindow)="receivedDateWindow($event)"
                                (zoomed)="handleZoom($event)">
                            </div>
                            <div class="dygraph-legend" #graphLegend [attr.id]="'graphlegend-' + i + '-' + j"></div>
                            <div class="events-overlay" [hidden]="!widget.settings.visual.showEvents" *ngIf="!multigraphEnabled">
                                <event-timeline 
                                [startTime]="startTime" 
                                [endTime]="endTime" 
                                [width]="eventsWidth" 
                                [events]="events"
                                [toolTipHeightFromTop]="size.height"
                                [timezone] = "options.labelsUTC ? 'utc' : 'local'" 
                                (canvasClicked)="updatedShowEventStream(true)"
                                (bucketClicked)="bucketClickedAtIndex($event)"
                                (newBuckets)="newBuckets($event)"></event-timeline>
                            </div>
                        </div>
            
                        <div class="graph-legend" [style.width]="legendWidth" [style.height]="legendHeight" *ngIf="!multigraphEnabled">
                            <ng-container *ngIf="widget.settings.legend.display">
                                <table mat-table matSort [dataSource]="legendDataSource">
                                    <ng-container matColumnDef="color">
                                            <th mat-header-cell *matHeaderCellDef></th>
                                            <td mat-cell *matCellDef="let element"><div class="line-series"  [style.backgroundColor]= "element.color"></div></td>
                                    </ng-container>
                                    <ng-container matColumnDef="name">
                                            <th mat-header-cell *matHeaderCellDef mat-sort-header>name</th>
                                            <td mat-cell *matCellDef="let element" [style.textDecoration]="options.visibility[element.srcIndex-1]===true? 'none': 'line-through'" > {{element.name}} </td>
                                    </ng-container>
                                    <ng-container *ngFor="let column of widget.settings.legend.columns || [] " [matColumnDef]="column">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ column }}</th>
                                        <td mat-cell *matCellDef="let element"> {{ root.normalizeValue(element[column], element.srcIndex) }}</td>
                                    </ng-container>
                                    <ng-container >
                                        <tr mat-header-row *matHeaderRowDef="legendDisplayColumns;sticky: true"></tr>
                                    </ng-container>
                                    <tr mat-row *matRowDef="let element; columns: legendDisplayColumns" (click)="stoggleChartSeries(element.srcIndex-1, false)" (dblclick)="toggleChartSeries(element.srcIndex-1, true)"></tr>
                                </table>
                            </ng-container>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <ng-template #graphRender let-root let-data="data" let-ctx="ctx">
            <div>
                <div class="dygraph-legend" #graphLegend [attr.id]="'graphlegend-' + ctx.yIdx + '-' + ctx.xIdx"></div>
                <div #dygraph class="graph-chart" [ngClass]="{'hide': root.widget.settings.legend.display &&  ( root.size.width <= 10 || root.size.height <= 10 ) }"
                    dygraphsChart
                    [chartType]="root.chartType"
                    [data]="data"
                    [size]="root.size"
                    [options]="root.getMultigraphOptions(ctx)"
                    [eventBuckets]="root.buckets"
                    [showEvents]="root.widget.settings.visual.showEvents"
                    [renderReady]="false"
                    (dateWindow)="root.receivedDateWindow($event)"
                    (zoomed)="root.handleZoom($event)">
                </div>
                
                <div class="events-overlay" [hidden]="!root.widget.settings.visual.showEvents" *ngIf="!multigraphEnabled">
                    <event-timeline 
                    [startTime]="root.startTime" 
                    [endTime]="root.endTime" 
                    [width]="root.eventsWidth" 
                    [events]="root.events"
                    [toolTipHeightFromTop]="root.size.height"
                    [timezone] = "root.options.labelsUTC ? 'utc' : 'local'" 
                    (canvasClicked)="root.updatedShowEventStream(true)"
                    (bucketClicked)="root.bucketClickedAtIndex($event)"
                    (newBuckets)="root.newBuckets($event)"></event-timeline>
                </div>
            </div>

            <div class="graph-legend" [style.width]="root.legendWidth" [style.height]="root.legendHeight" *ngIf="!multigraphEnabled">
                <ng-container *ngIf="root.widget.settings.legend.display">
                    <table mat-table matSort [dataSource]="root.legendDataSource">
                        <ng-container matColumnDef="color">
                                <th mat-header-cell *matHeaderCellDef></th>
                                <td mat-cell *matCellDef="let element"><div class="line-series"  [style.backgroundColor]= "element.color"></div></td>
                        </ng-container>
                        <ng-container matColumnDef="name">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header>name</th>
                                <td mat-cell *matCellDef="let element" [style.textDecoration]="root.options.visibility[element.srcIndex-1]===true? 'none': 'line-through'" > {{element.name}} </td>
                        </ng-container>
                        <ng-container *ngFor="let column of root.widget.settings.legend.columns || [] " [matColumnDef]="column">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ column }}</th>
                            <td mat-cell *matCellDef="let element"> {{ root.normalizeValue(element[column], element.srcIndex) }}</td>
                        </ng-container>
                        <ng-container >
                            <tr mat-header-row *matHeaderRowDef="root.legendDisplayColumns;sticky: true"></tr>
                        </ng-container>
                        <tr mat-row *matRowDef="let element; columns: root.legendDisplayColumns" (click)="root.toggleChartSeries(element.srcIndex-1, false)" (dblclick)="root.toggleChartSeries(element.srcIndex-1, true)"></tr>
                    </table>
                </ng-container>
            </div>
        </ng-template>
        
        <!--
        <ng-template [ngIf]="!multigraphEnabled">
            <div>
                <div #dygraph class="graph-chart" [ngClass]="{'hide': widget.settings.legend.display &&  ( size.width <= 10 || size.height <= 10 ) }"
                    dygraphsChart
                    [chartType]="chartType"
                    [data]="data"
                    [size]="size"
                    [options]="options"
                    [eventBuckets]="buckets"
                    [showEvents]="widget.settings.visual.showEvents"
                    [renderReady]="renderReady"
                    (dateWindow)="receivedDateWindow($event)"
                    (zoomed)="handleZoom($event)">
                </div>
                <div class="dygraph-legend" #graphLegend></div>
                <div class="events-overlay" [hidden]="!widget.settings.visual.showEvents">
                    <event-timeline 
                    [startTime]="startTime" 
                    [endTime]="endTime" 
                    [width]="eventsWidth" 
                    [events]="events"
                    [toolTipHeightFromTop]="size.height"
                    [timezone] = "this.options.labelsUTC ? 'utc' : 'local'" 
                    (canvasClicked)="updatedShowEventStream(true)"
                    (bucketClicked)="bucketClickedAtIndex($event)"
                    (newBuckets)="newBuckets($event)"></event-timeline>
                </div>
            </div>

            <div class="graph-legend" [style.width]="legendWidth" [style.height]="legendHeight">
                <ng-container *ngIf="widget.settings.legend.display">
                    <table mat-table matSort [dataSource]="legendDataSource">
                        <ng-container matColumnDef="color">
                                <th mat-header-cell *matHeaderCellDef></th>
                                <td mat-cell *matCellDef="let element"><div class="line-series"  [style.backgroundColor]= "element.color"></div></td>
                        </ng-container>
                        <ng-container matColumnDef="name">
                                <th mat-header-cell *matHeaderCellDef mat-sort-header>name</th>
                                <td mat-cell *matCellDef="let element" [style.textDecoration]="options.visibility[element.srcIndex-1]===true? 'none': 'line-through'" > {{element.name}} </td>
                        </ng-container>
                        <ng-container *ngFor="let column of widget.settings.legend.columns || [] " [matColumnDef]="column">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ column }}</th>
                            <td mat-cell *matCellDef="let element"> {{ normalizeValue(element[column], element.srcIndex) }}</td>
                        </ng-container>
                        <ng-container >
                            <tr mat-header-row *matHeaderRowDef="legendDisplayColumns;sticky: true"></tr>
                        </ng-container>
                        <tr mat-row *matRowDef="let element; columns: legendDisplayColumns" (click)="toggleChartSeries(element.srcIndex-1, false)" (dblclick)="toggleChartSeries(element.srcIndex-1, true)"></tr>
                    </table>
                </ng-container>
            </div>
        </ng-template>-->
        
        <!-- MULTIGRAPH OUTPUT 
        <ng-template [ngIf]="multigraphEnabled">
            <div class="multigraph-output">
                <div class="multi-graph-container" [ngClass]="{'multigraph-grid-mode': multigraphMode === 'grid', 'multigraph-freeflow-mode': multigraphMode === 'freeflow'}">

                    <ng-container *ngIf="multigraphMode === 'grid'">
                        <div class="graph-row" *ngFor="let row of fakeLoopData; let i = index;">
                            <div class="graph-cell" *ngFor="let cell of fakeLoopData; let j = index;">
                                grid-cell-[{{i}},{{j}}]
                            </div>
                        </div>
                    </ng-container>
                    <ng-container *ngIf="multigraphMode === 'freeflow'">
                        <div class="graph-row" *ngFor="let row of fakeLoopData; let i = index;">
                            <div class="row-label">ROW {{i}}</div>
                            <div class="graph-cell" *ngFor="let cell of fakeLoopData; let j = index;">
                                grid-cell-[{{i}},{{j}}]
                            </div>
                        </div>
                    </ng-container>
                </div>
            </div>
        </ng-template>-->

        <div class="loading-spinner size-s color-primary" *ngIf="nQueryDataLoading > 0"></div>
        <div class="error" *ngIf="error" (click)="showError()">
            <mat-icon>error</mat-icon>
        </div>
        <div class="debug" *ngIf="debugData" (click)="showDebug()">
            <mat-icon>info</mat-icon> {{ this.widget.id }}
        </div>
        <div class="apply-tpl-status">
            <mat-icon fontSet="denali" matTooltip="Dashboard tag filters disabled!"
                 fontIcon="d-lock-close-solid" *ngIf="!isApplyTpl()"></mat-icon>
        </div>
    </div>
</div>

<!-- NOTE: This needs to move to other component -->
<div class="widget-controls-container" *ngIf="editMode">
    <!-- tabs with config content -->
    <mat-tab-group class="widget-configs" color="primary" [@.disabled]="'true'">
        <mat-tab label="Queries" class="test">
            <!-- ng-template is to lazy-load tab content (see: https://material.angular.io/components/tabs/overview#lazy-loading ) -->
            <ng-template matTabContent>
                <widget-config-metric-queries [options]="{enableMultipleQueries: true}" [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-metric-queries>
            </ng-template>
        </mat-tab>
        <mat-tab label="Time Configuration" [disabled]="editQueryId">
            <ng-template matTabContent>
                <widget-config-time [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-time>
            </ng-template>
        </mat-tab>
        <mat-tab label="Axes" [disabled]="editQueryId">
            <ng-template matTabContent>
                <widget-config-axes [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-axes>
            </ng-template>
        </mat-tab>
        <mat-tab label="Visual Appearance" [disabled]="editQueryId">
            <ng-template matTabContent>
                <widget-config-visual-appearance [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-visual-appearance>
            </ng-template>
        </mat-tab>
        <!--<mat-tab label="Alerts">
            <ng-template matTabContent>
                <widget-config-alerts [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-alerts>
            </ng-template>
        </mat-tab>-->
        <mat-tab label="Legend" [disabled]="editQueryId">
                <ng-template matTabContent>
                    <widget-config-legend [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-legend>
                </ng-template>
        </mat-tab>
        <mat-tab label="Multigraph" [disabled]="editQueryId">
                <ng-template matTabContent>
                    <widget-config-multigraph [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-multigraph>
                </ng-template>
        </mat-tab>
        <mat-tab label="Meta Data" [disabled]="editQueryId">
                <ng-template matTabContent>
                    <widget-config-general [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-general>
                </ng-template>
        </mat-tab>
        <mat-tab label="Events" class="events" [disabled]="editQueryId">
                <ng-template matTabContent class="events">
                    <div class="events-config">
                        <widget-config-events [widget]="widget" (widgetChange)="updateConfig($event);"></widget-config-events>
                        <div *ngIf="widget.settings.visual.showEvents" class="event-result-title"> Preview </div>
                        <event-list *ngIf="widget.settings.visual.showEvents" class="events-list" [events]="events" [timezone]="timezone" [startTime]="startTime" [endTime]="endTime" [previewLimit]="previewEventsCount">
                        </event-list>
                    </div>
                </ng-template>
        </mat-tab>
        <mat-tab>
            <!-- custom tab label. (see: https://material.angular.io/components/tabs/overview#labels) -->
            <!-- <ng-template mat-tab-label>
                &lt;/&gt; Query Editor
            </ng-template> -->
            <ng-template matTabContent>
                <widget-config-query-inspector [widget]="widget"></widget-config-query-inspector>
            </ng-template>
        </mat-tab>
    </mat-tab-group>
    <div class="widget-actions"  *ngIf="!editQueryId">
        <!-- controls to save/cancel -->
        <button mat-raised-button color="primary" class="mat-elevation-z0" (click)="applyConfig()">Apply to Dashboard</button>
        <button mat-stroked-button color="primary" class="mat-elevation-z0" (click)="closeViewEditMode()">Cancel</button>
    </div>
</div>
