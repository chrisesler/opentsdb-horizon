<mat-toolbar mat-dialog-title>
    <span class="dialog-title">Add Query</span>
    <span class="flex-spacer"></span>
    <span>
        <button mat-button color="primary" class="close-dialog-btn" [mat-dialog-close]="true">
            <mat-icon fontSet="denali" fontIcon="d-close"></mat-icon>
        </button>
    </span>
</mat-toolbar>
<mat-dialog-content>
    <!-- graph preview -->
    <div style="height: 350px;" class="graph-preview-pane" *ngIf="selectedMetrics.length > 0">
        <div class="graph-preview" fxLayout="row">
            <div class="graph-output" fxFlex="1 1 100%" fxLayout="column">
                <div class="graph-metric-list-title" fxFlex="1 1 30px">
                    <strong>Line Chart Preview</strong>
                </div>
                <div id="dygraph_div" dygraphsChart [chartType]="chartType" [data]="data" [size]="size" [options]="options">
                </div>
            </div>
            <div class="graph-metrics" fxFlex="1 1 100%" fxLayout="column">
                <!-- list of metrics in graph goes here -->
                <div class="graph-metric-list-title" fxFlex="1 1 30px">
                    <strong>Selected Queries ({{selectedMetrics.length}})</strong>
                </div>
                <div class="graph-metric-list has-scroller" fxFlex="1 1 100%">
                    <div class="is-scroller">
                        <mat-list>
                            <mat-list-item class="graph-metric-list-item" *ngFor="let metric of selectedMetrics">
                                <button mat-icon-button (click)="removeSelectedMetric(metric)">
                                    <mat-icon>add_circle_outline</mat-icon>
                                </button>
                                <div class="metric-details">
                                    <div class="metric-name">
                                        {{metric.metric}}
                                    </div>
                                    <div class="metric-tags">
                                        <span class="metric-tag" *ngFor="let tag of extractMetricTagKeys(metric,true)">
                                            {{tag}}: <strong>{{metric[tag]}}</strong>
                                        </span>
                                    </div>
                                </div>
                            </mat-list-item>
                        </mat-list>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- search controls and output-->
    <div class="content-container">
        <div class="metric-search-input-controls" fxLayout="column">
            <div class="mat-toolbar-row">
                <div class="navbar-item namespace-search-control" fxFlex="1 1 288px" fxLayout="column">
                    <!--<strong>Search Results</strong>-->
                    <mat-form-field appearance="fill" [color]="'primary'" floatLabel="never">
                        <!--<mat-label>Namespace</mat-label>-->
                        <input type="text" matInput placeholder="Namespace" [formControl]="namespaceControl" [matAutocomplete]="namespaceAuto" (keydown.enter)="namespaceKeydown($event)"
                        />
                    </mat-form-field>
                    <mat-autocomplete #namespaceAuto="matAutocomplete" (optionSelected)="namespaceOptionSelected($event)">
                        <mat-option *ngFor="let option of filteredNamespaceOptions | async" [value]="option">
                            {{ option }}
                        </mat-option>
                    </mat-autocomplete>
                </div>
                <div class="navbar-item metric-search-control" fxFlex="1 1 100%" *ngIf="selectedNamespace">
                    <mat-form-field appearance="fill" [color]="'primary'" floatLabel="never">
                        <!--<mat-label>Metric Search</mat-label>-->
                        <input matInput placeholder="Metric Search" [formControl]="searchQueryControl" (keydown.enter)="submitSearch($event)">
                        <mat-icon matSuffix>search</mat-icon>
                        <!--<mat-hint>Displaying 2,000,000,000 results that include "blah blah" in tag keys and values. Grouping results
                            by tags and other amazing stuffz</mat-hint>-->
                    </mat-form-field>
                </div>
                <div class="navbar-item metric-pivot-control" fxFlex="1 1 120px" *ngIf="selectedNamespace" style="display: flex; flex-direction: column;">
                    <span class="mat-caption">Display results by</span>
                    <nav mat-tab-nav-bar class="time-preset-options sliding-button-group">
                        <a mat-tab-link [active]="searchFlag === '0'" (click)="click_changeSearchFlag('0')">Tags</a>
                        <a mat-tab-link [active]="searchFlag === '1'" (click)="click_changeSearchFlag('1')">Metrics</a>
                    </nav>
                </div>
            </div> 
        </div>
        <div class="metric-result-count" *ngIf="resultCount > 0">
            <mat-hint class="mat-caption">Displaying <strong>{{resultCount}}</strong> results in the <strong>{{namespaceControl.value}}</strong> that include "<strong>{{searchQueryControl.value}}</strong>" in tag keys and values. Grouping results by {{ searchFlag === '0' ? 'tags' : 'metrics'}}.</mat-hint>  
        </div>
        <!-- DUMP RESULTS STUFF HERE -->
        <div class="metric-results-output" fxLayout="row" fxFlex="1 1 100%" style="height: 100%;">
            <div class="available-tags" fxFlex="1 1 300px" fxLayout="column" >
                <div class="column-content has-scroller" fxFlex="1 1 100%">
                    <div class="is-scroller">
                        <mat-accordion multi="false" displayMode="flat">
                            <mat-expansion-panel class="mat-elevation-z0" *ngFor="let k of results; let index=index" [expanded]="index === 0">
                                <mat-expansion-panel-header [expandedHeight]="'48px'" [collapsedHeight]="'48px'">
                                    <span class="key">{{ k.key }}</span> <span class="count">({{k.values.length}})</span>
                                </mat-expansion-panel-header>
                                <!-- for lazy rendering (see: https://material.angular.io/components/expansion/overview#lazy-rendering) -->
                                <ng-template matExpansionPanelContent>
                                    <div class="available-tag-values-container" [ngClass]="{'has-scroller': k.values.length > 5}">
                                        <div [ngClass]="{'is-scroller': k.values.length > 5}">
                                            <mat-nav-list>
                                                <mat-list-item *ngFor="let tv of k.values" [ngClass]="{'is-selected': selectedResultSet === tv}" (click)="listSelectedTag(tv)">
                                                    <div><span class="key">{{ tv.key}}</span> <span class="count">({{tv.values.length}})</span></div>
                                                </mat-list-item>
                                            </mat-nav-list>
                                        </div>
                                    </div>
                                </ng-template>
                            </mat-expansion-panel>
                        </mat-accordion>
                    </div>
                </div>
            </div>
            <div fxFlex="1 1 100%" fxLayout="column" class="search-results">
                
                <div fxFlex="1 1 100%" class="result-content" *ngIf="selectedResultSet && selectedResultSet.values">
                    <!-- content -->
                    <table mat-table [dataSource]="selectedResultSet.values" class="mat-elevation-z0" style="width: 100%;">
                        <!-- define the rows -->
                        <tr mat-header-row *matHeaderRowDef="selectedResultSetTagKeys.displayed; sticky: true;"></tr>
                        <tr mat-row *matRowDef="let row; columns: selectedResultSetTagKeys.displayed;" [ngClass]="{'selected-metric-bg': selectedMetrics.includes(row)}"></tr>

                        <!-- Select Metric-->
                        <ng-container matColumnDef="selectMetric">
                            <th mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let element">
                                <button class="select-metric-btn" mat-icon-button (click)="selectMetric(element)">
                                    <mat-icon>add_circle_outline</mat-icon>
                                </button>
                            </td>
                        </ng-container>
                    
                        <!-- Common tags-->
                        <ng-container *ngFor="let column of selectedResultSetTagKeys.common"  matColumnDef="{{ column }}">
                            <th mat-header-cell *matHeaderCellDef>{{ column }}</th>
                            <td mat-cell *matCellDef="let element">{{ element[column] || '[ no data ¯\_(ツ)_/¯ ]' }}</td>
                        </ng-container>
                    
                        <!-- Other tags (not common) -->
                        <ng-container matColumnDef="other" *ngIf="selectedResultSetTagKeys.uncommon.length > 0">
                            <th mat-header-cell *matHeaderCellDef> Other</th>
                            <td mat-cell class="metric-tags" *matCellDef="let element">
                                <ng-container *ngFor="let tag of selectedResultSetTagKeys.uncommon">
                                    <mat-chip *ngIf="element[tag]">
                                        {{tag}}: <strong>{{element[tag]}}</strong>
                                    </mat-chip>
                                </ng-container>
                            </td>
                        </ng-container>
                    </table>
                    <!-- end content-->
                </div>
            </div>
        </div>
    </div>
</mat-dialog-content>
<mat-dialog-actions>
    <button mat-raised-button color="primary" class="mat-elevation-z0" (click)="onClick_Apply()">APPLY</button>
    <button mat-stroked-button color="primary" class="mat-elevation-z0" (click)="onClick_Cancel()">CANCEL</button>
</mat-dialog-actions>
