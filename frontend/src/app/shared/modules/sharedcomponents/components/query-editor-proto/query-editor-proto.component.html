<mat-toolbar class="namespace-bar"
    [ngClass]="{'is-expanded': query.namespace || query.metrics.length || query.filters.length}">
    <div class="toolbar-item query-index">
        <span>{{ label }}</span>
    </div>
    <div class="toolbar-item">
        <span class="title"> Namespace </span>
    </div>
    <div class="toolbar-item">
        <span class="namespace-value" *ngIf="!editNamespace" (click)="editNamespace=true;">
            {{ query.namespace }}
        </span>
    </div>
    <div class="toolbar-item">
        <span class="value" *ngIf="editNamespace || !query.namespace.trim() ">
            <namespace-autocomplete [value]="query.namespace" (nschange)="saveNamespace($event)" (blur)="cancelSaveNamespace($event)"></namespace-autocomplete>
        </span>
    </div>
    <span class="flex-spacer"></span>
    <div class="toolbar-item action-icons" *ngIf="!edit.length">
        <button mat-icon-button color="primary" (click)="toggleQuery(); $event.stopPropagation();">
            <mat-icon fontSet="denali" fontIcon="d-eye-open" *ngIf="query.settings.visual.visible"></mat-icon>
            <mat-icon fontSet="denali" fontIcon="d-eye-close" *ngIf="!query.settings.visual.visible"></mat-icon>
        </button>
        <button mat-icon-button color="primary" (click)="deleteQuery(); $event.stopPropagation();">
            <mat-icon fontSet="denali" fontIcon="d-trash"></mat-icon>
        </button>
    </div>
</mat-toolbar>
<div class="metric-wrapper" *ngIf="query.namespace || query.metrics.length || query.filters.length">
    <!-- CONTAINER FOR THE METRICS-->
    <div class="metric-list-wrapper">
        <!-- LOOP THROUGH METRICS 
             SECOND COLUMN IS EMPTY TO BE ABLE TO TAKE THE ABSOLUTE POSITIONED COMMON TAGS BOX -->
        <div class="metric-list-item" *ngFor="let metric of getMetricsByType('metrics'); let i = index">
            <div class="metric-row-data metric-index">
                
                <button mat-flat-button [matMenuTriggerFor]="metricActionMenu" [matMenuTriggerData]="{metric: metric}">
                    <span class="label">
                        <mat-icon fontSet="denali" [fontIcon]="metric.enabled ? 'd-check' : 'd-minus'" *ngIf="canDisableMetrics"></mat-icon>
                        <span>m{{ i+1 }}</span>
                    </span>
                    <span class="mat-select-arrow-wrapper">
                        <div class="mat-select-arrow"></div>
                    </span>
                </button>
            </div>
            <div class="metric-row-data metric-name">
                <span *ngIf="editMetricIndex !== i" (click)="editMetricIndex=i;" matTooltip="{{metric.name}}" matTooltipPosition="right">{{metric.name}}</span>
                <metric-autocomplete 
                    *ngIf="editMetricIndex === i"
                    [namespace]="query.namespace"
                    [metrics]="[metric.name]"
                    [filters]="query.filters" 
                    (metricOutput)="updateMetric($event, i);"
                    (blur)="editMetricIndex=-1"></metric-autocomplete>
            </div>
            <div class="metric-row-data tag-spacer">
            </div>
            <div class="metric-row-data aggregator">
                <tag-aggregator
                    [value]="metric.tagAggregator"
                   (change)="setMetricTagAggregator(metric.id, $event)"></tag-aggregator>
                <span>BY</span>
            </div>
            <div class="metric-row-data tags">
                <dropdown-metric-tags
                    [namespace]="query.namespace"
                    [metric]="metric.name"
                    [selected]="metric.groupByTags"
                    (change)="setMetricGroupByTags(metric.id, $event)"></dropdown-metric-tags>
            </div>
            <!-- CUSTOM FUNCTION DISPLAY - THIS WILL LOOP -->
            <div class="metric-row-data custom-function">
                <div class="function-label">
                    <span>function label</span>
                </div>
                <div class="function-value">
                    <mat-form-field appearance="fill" floatLabel="never">
                        <input matInput placeholder="enter value">
                        <mat-icon matSuffix
                            matTooltip="Info about the function"
                            fontSet="denali"
                            fontIcon="d-information-circle"></mat-icon>
                    </mat-form-field>
                </div>
                <div class="function-remove">
                    <button mat-icon-button>
                        <mat-icon fontSet="denali" fontIcon="d-close-circle-solid"></mat-icon>
                    </button>
                </div>
            </div>
            <div class="metric-row-data custom-function">
                <div class="function-label">
                    <span>function label</span>
                </div>
                <div class="function-value">
                    <mat-form-field appearance="fill" floatLabel="never">
                        <input matInput placeholder="enter value">
                        <mat-icon matSuffix
                            matTooltip="Info about the function"
                            fontSet="denali"
                            fontIcon="d-information-circle"></mat-icon>
                    </mat-form-field>
                </div>
                <div class="function-remove">
                    <button mat-icon-button>
                        <mat-icon fontSet="denali" fontIcon="d-close-circle-solid"></mat-icon>
                    </button>
                </div>
            </div>
            <div class="metric-row-data custom-function">
                <div class="function-label">
                    <span>function label</span>
                </div>
                <div class="function-value">
                    <mat-form-field appearance="fill" floatLabel="never">
                        <input matInput placeholder="enter value">
                        <mat-icon matSuffix
                            matTooltip="Info about the function"
                            fontSet="denali"
                            fontIcon="d-information-circle"></mat-icon>
                    </mat-form-field>
                </div>
                <div class="function-remove">
                    <button mat-icon-button>
                        <mat-icon fontSet="denali" fontIcon="d-close-circle-solid"></mat-icon>
                    </button>
                </div>
            </div>
            <!-- ADD FUNTION ALWAYS LAST -->
            <div class="add-function"
                [matMenuTriggerFor]="functionSelectionMenu"
                [matMenuTriggerData]="{metric: metric}"
                (click)="functionMenuOpened($event, i)"
                (menuClosed)="functionMenuClosed($event)">
                <button mat-flat-button color="primary">
                    <mat-icon svgIcon="function_icon"></mat-icon>
                    <div class="mat-select-arrow-wrapper">
                        <div class="mat-select-arrow"></div>
                    </div>
                </button> 
            </div>
  
        </div>
        <!-- ADD METRIC - STARTS -->
        <div class="metric-list-item" *ngIf="isAddMetricProgress || !query.metrics.length">
            <div class="metric-row-data metric-name">
                <metric-autocomplete
                    [focus]="isAddMetricProgress"
                    [multiple]="true"
                    [namespace]="query.namespace"
                    [filters]="query.filters"
                    (metricOutput)="updateMetric($event, null);"
                    (blur)="isAddMetricProgress=false"></metric-autocomplete>
            </div>
        </div>
        <!-- ADD METRIC - ENDS -->
        <form [formGroup]="fg">
            <div class="metric-list-item" *ngFor="let metric of getMetricsByType('expression'); let i = index">
                <div class="metric-row-data metric-index">
                    <button mat-flat-button [matMenuTriggerFor]="metricActionMenu" [matMenuTriggerData]="{metric: metric}">
                        <span class="label">
                            <mat-icon fontSet="denali" [fontIcon]="metric.enabled ? 'd-check' : 'd-minus'" *ngIf="canDisableMetrics"></mat-icon>
                            <span>e{{ i+1 }}</span>
                        </span>
                        <span class="mat-select-arrow-wrapper">
                            <div class="mat-select-arrow"></div>
                        </span>
                    </button>
                </div>
                <div class="metric-row-data metric-name">
                    <span *ngIf="editExpressionId !== metric.id" (click)="editExpression(metric.id);">{{ getExpressionUserInput(metric.expression) }}</span>
                    <mat-form-field *ngIf="editExpressionId === metric.id" class="expression-input-field" appearance="outline" color="primary" floatLabel="never">
                        <input matInput placeholder="e.g. m1 + m2" [formControlName]="metric.id" (blur)="updateExpression(metric.id, $event)" (keyup.enter)="updateExpression(metric.id, $event)" autocomplete="off">
                        <mat-error *ngIf="fg.controls[metric.id].errors && fg.controls[metric.id].errors.invalid">
                            Invalid Expression.
                        </mat-error>
                    </mat-form-field>
                </div>
                <div class="metric-row-data tag-spacer"></div>
            </div>
            <!-- ADD EXPRESSION - STARTS -->
            <div class="metric-list-item" *ngIf="isAddExpressionProgress && query.metrics.length">
                <div class="metric-row-data metric-index">
                    <button mat-flat-button>
                        <span class="label">
                            <mat-icon fontSet="denali" [fontIcon]="metric.enabled ? 'd-check' : 'd-minus'" *ngIf="canDisableMetrics"></mat-icon>
                            <span>e{{ (getMetricsByType('expression')).length }}</span>
                        </span>
                        <span class="mat-select-arrow-wrapper">
                            <div class="mat-select-arrow" style="opacity: 0"></div>
                        </span>
                    </button>
                </div>
                <div class="metric-row-data expression">
                    <mat-form-field class="expression-input-field" appearance="outline" color="primary" floatLabel="never">
                        <input matInput placeholder="e.g. m1 + m2"  formControlName="-1" (blur)="updateExpression(-1, $event)" (keyup.enter)="updateExpression(-1, $event)" autocomplete="off">
                        <mat-error *ngIf="fg.controls['-1'].errors && fg.controls['-1'].errors.invalid">
                            Invalid Expression.
                        </mat-error>
                    </mat-form-field>
                </div>
            </div>
        </form>
        <!-- ADD EXPRESSION - ENDS -->
    </div>
    <!-- THIS IS THE TOP TO BOTTOM CONTAINER FOR THE COMMON TAGS
         IT WILL BE POSITIONED ABSOLUTE -->
    <div class="common-tag-wrapper" (click)="showTagFilterMenu()">
        <span [matMenuTriggerFor]="tagFilterMenu" #tagFilterMenuTrigger="matMenuTrigger" class="tag-filter-menu-trigger"></span>
        <div class="tags-selected" *ngIf="query.filters.length">
            <div class="tags-selected-header">
                <span><strong>Tag Filters</strong> ({{ query.filters.length }})</span>
                <span class="explicit-match"><mat-checkbox (click)="$event.stopPropagation();" [checked]="query.settings.explicitTagMatch" (change)="toggleExplictTagMatch($event)">Only match selected tag keys</mat-checkbox></span>
            </div>
            <mat-list class="tag-filter-rows" role="list">
                <mat-list-item class="tag" role="listitem" *ngFor="let filter of query.filters; let index=index">
                    <div class="tag-filter-detail">
                        <strong>{{ filter.tagk }}:</strong> <span>{{ filter.filter.join(', ') }}</span>
                    </div>
                </mat-list-item>
            </mat-list>
        </div>
        <div *ngIf="!query.filters.length">
            <button mat-button color="primary" class="add-tag-filter-button"> Add Tag filters </button>
        </div>
    </div>
</div>
<div class="metric-action-buttons" *ngIf="query.namespace || query.metrics.length || query.filters.length">
    <button mat-button color="primary" *ngIf="!isAddMetricProgress || !query.metrics.length " (click)="isAddMetricProgress=true">
        <mat-icon fontSet="denali" fontIcon="d-add"></mat-icon>
        <span>Metric</span>
    </button>
    <button mat-button color="primary" *ngIf="query.metrics.length" (click)="editExpression(-1)" [disabled]="query.metrics.length === 0">
            <mat-icon fontSet="denali" fontIcon="d-add"></mat-icon>
            <span>Expression</span>
    </button>
</div>
<!-- METRIC MENU -->
<mat-menu class="metric-action-cdk-menu" #metricActionMenu="matMenu" hasBackdrop="true">
    <ng-template matMenuContent let-metric="metric">
        <!-- conditional button -->
        <button mat-menu-item *ngIf="canDisableMetrics">
            <mat-icon fontSet="denali" [fontIcon]="metric.enabled ? 'd-eye-close' : 'd-eye-open'"></mat-icon>
            <span>{{metric.enabled ? 'Disable' : 'Enable'}}</span>
        </button>
        <button mat-menu-item>
            <mat-icon fontSet="denali" fontIcon="d-duplicate"></mat-icon>
            <span>Clone</span>
        </button>
        <button mat-menu-item>
            <mat-icon fontSet="denali" fontIcon="d-trash"></mat-icon>
            <span>Delete</span>
        </button>
    </ng-template>
</mat-menu>
<!-- TAG FILTER MENU -->
<mat-menu class="tag-filters-menu-wrapper" yPosition="below" #tagFilterMenu="matMenu" >
    <div class="filter" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" *ngIf="query.namespace">
        <inline-filter-editor [namespace]="query.namespace" [metrics]="query.metrics" [filters]="query.filters" (filterOutput)="updateFilters($event);" ></inline-filter-editor>
    </div>
</mat-menu>
<!-- FUNCTION MENU-->
<mat-menu class="function-selection-cdk-menu" #functionSelectionMenu="matMenu">
    <ng-template matMenuContent let-metric="metric">
        <div class="function-selection-wrapper" (click)="$event.stopPropagation();" style="width: 300px; height: 200px;">
            <div class="function-categories">
                <mat-nav-list>
                    <a mat-list-item 
                        [ngClass]="{'is-active': i === selectedFunctionCategoryIndex}"
                        *ngFor="let category of fakeFunctionCategories; let i = index;"
                        (click)="selectFunctionCategory($event, i)">
                        <span>{{ category.label }}</span>
                        <mat-icon fontSet="denali" fontIcon="d-arrowhead-right"></mat-icon>
                    </a>
                </mat-nav-list>
            </div>
            <div class="funtion-category-items">
                <mat-nav-list *ngIf="selectedFunctionCategoryIndex >= 0">
                    <a mat-list-item *ngFor="let catFunction of fakeFunctionCategories[selectedFunctionCategoryIndex].functions; let j = index;" (click)="addFunction($event, i, j)">
                        <span>{{ catFunction.label }}</span>
                    </a>
                </mat-nav-list>
            </div>
        </div>
    </ng-template>
</mat-menu>