<mat-toolbar class="namespace-bar"
    [ngClass]="{'is-expanded': query.namespace || query.metrics.length || query.filters.length}">
    <div class="toolbar-item query-index">
        <span>{{ label }}</span>
    </div>
    <div class="toolbar-item">
        <span class="title"> Namespace </span>
    </div>
    <div class="toolbar-item">
        <span class="namespace-value" *ngIf="!editNamespace" (click)="editNamespace=true;">
            {{ query.namespace }}
        </span>
    </div>
    <div class="toolbar-item">
        <span class="value" *ngIf="editNamespace || !query.namespace.trim() ">
            <namespace-autocomplete [value]="query.namespace" (nschange)="saveNamespace($event)" (blur)="cancelSaveNamespace($event)"></namespace-autocomplete>
        </span>
    </div>
    <span class="flex-spacer"></span>
    <div class="toolbar-item action-icons" *ngIf="!edit.length && canDisableMetrics">
        <button mat-icon-button color="primary" (click)="toggleQuery(); $event.stopPropagation();">
            <mat-icon fontSet="denali" fontIcon="d-eye-open" *ngIf="query.settings.visual.visible"></mat-icon>
            <mat-icon fontSet="denali" fontIcon="d-eye-close" *ngIf="!query.settings.visual.visible"></mat-icon>
        </button>
        <button mat-icon-button color="primary" (click)="deleteQuery(); $event.stopPropagation();">
            <mat-icon fontSet="denali" fontIcon="d-trash"></mat-icon>
        </button>
    </div>
</mat-toolbar>
<div class="metric-wrapper" [formGroup]="fg" *ngIf="query.namespace || query.metrics.length || query.filters.length">
    <!-- CONTAINER FOR THE METRICS-->
    
    <div class="metric-list-wrapper">
        <!-- CONTAINER FOR THE COMMON TAGS-->
        <div class="common-tags">
            <span class="common-tags-label">Tag filters</span>
            <div class="common-tags-wrapper" (click)="showTagFilterMenu()">
                <span [matMenuTriggerFor]="tagFilterMenu" #tagFilterMenuTrigger="matMenuTrigger" class="tag-filter-menu-trigger"></span>
                <div class="tags-selected" *ngIf="query.filters.length">
                    <div class="tags-selected-header">
                        <span><strong>Tag Filters</strong> ({{ query.filters.length }})</span>
                        <span class="explicit-match"><mat-checkbox (click)="$event.stopPropagation();" [checked]="query.settings.explicitTagMatch" (change)="toggleExplictTagMatch($event)">Only match selected tag keys</mat-checkbox></span>
                    </div>
                    <mat-list class="tag-filter-rows" role="list">
                        <mat-list-item class="tag" role="listitem" *ngFor="let filter of query.filters; let index=index">
                            <div class="tag-filter-detail">
                                <strong>{{ filter.tagk }}:</strong> <span>{{ filter.filter.join(', ') }}</span>
                            </div>
                        </mat-list-item>
                    </mat-list>
                </div>
                <div *ngIf="!query.filters.length">
                    <button mat-button color="primary" class="add-tag-filter-button"> Add Tag filters </button>
                </div>
            </div>
        </div>
        <!-- LOOP THROUGH METRICS 
             SECOND COLUMN IS EMPTY TO BE ABLE TO TAKE THE ABSOLUTE POSITIONED COMMON TAGS BOX -->
        <table mat-table #metricTable [dataSource]="metricTableDataSource" class="query-metric-table mat-elevation-z0">

            <!-- INDEX Column -->
            <ng-container matColumnDef="metric-index">
                <th mat-header-cell *matHeaderCellDef>metric index</th>
                <td mat-cell *matCellDef="let data; let i = dataIndex;">
                    <div class="metric-row-data metric-index">
                        <button mat-flat-button [matMenuTriggerFor]="metricActionMenu" [matMenuTriggerData]="{metric: data.metric}">
                            <span class="label">
                                <mat-icon fontSet="denali" [fontIcon]="data.metric.settings.visual.visible ? 'd-check' : 'd-minus'" *ngIf="canDisableMetrics"></mat-icon>
                                <span>{{ data.indexLabel}}</span>
                                <!--<span>m00</span>-->
                            </span>
                            <span class="mat-select-arrow-wrapper">
                                <div class="mat-select-arrow"></div>
                            </span>
                        </button>
                    </div>
                </td>
            </ng-container>
            <!-- NAME Column -->
            <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef> Name </th>
                <td mat-cell *matCellDef="let data;">
                    <!-- if metric -->
                    <ng-template [ngIf]="data.type === 'metric'">
                        <div class="metric-row-data metric-name">
                            <div class="display-name" 
                                *ngIf="editMetricId !== data.metric.id"
                                (click)="editMetricId = data.metric.id;"
                                matTooltip="{{data.metric.name}}"
                                matTooltipPosition="right">
                                <span>{{data.metric.name}}</span>
                                <mat-icon fontSet="denali" fontIcon="d-pencil"></mat-icon>
                            </div>
                            <metric-autocomplete 
                                *ngIf="editMetricId === data.metric.id"
                                [namespace]="query.namespace"
                                [metrics]="[data.metric.name]"
                                [filters]="query.filters" 
                                (metricOutput)="updateMetric($event, data.metric.id);"
                                (blur)="editMetricIndex=-1"></metric-autocomplete>
                        </div>
                    </ng-template>
                    <!-- if expression -->
                    <ng-template [ngIf]="data.type === 'expression'">
                        <div class="metric-row-data expression">
                            <div class="display-name" 
                                *ngIf="editExpressionId !== data.metric.id"
                                (click)="editExpression(data.metric.id);"
                                matTooltip="{{ getExpressionUserInput(data.metric.expression) }}"
                                matTooltipPosition="right">
                                <span>{{ getExpressionUserInput(data.metric.expression) }}</span>
                                <mat-icon fontSet="denali" fontIcon="d-pencil"></mat-icon>
                            </div>
                            <mat-form-field *ngIf="editExpressionId === data.metric.id" class="expression-input-field" appearance="fill" color="primary" floatLabel="never">
                                <input matInput placeholder="e.g. m1 + m2" [formControlName]="data.metric.id" (blur)="updateExpression(data.metric.id, $event)" (keyup.enter)="updateExpression(data.metric.id, $event)" autocomplete="off">
                                <mat-error *ngIf="fg.controls[data.metric.id].errors && fg.controls[data.metric.id].errors.invalid">
                                    Invalid Expression.
                                </mat-error>
                            </mat-form-field>
                        </div>
                    </ng-template>
                </td>
            </ng-container>
            <!-- AGGREGATOR AND FUNCTIONS Column -->
            <ng-container matColumnDef="modifiers">
                <th mat-header-cell *matHeaderCellDef>modifier</th>
                <td mat-cell *matCellDef="let data;" style="width: 100%">
                    <!-- aggregator -->
                    <div class="metric-row-data tag-aggregator">
                        <div class="tag-aggregator-wrapper">
                            <tag-aggregator
                                [value]="data.metric.tagAggregator"
                            (change)="setMetricTagAggregator(data.metric.id, $event)"></tag-aggregator>
                            <span class="by-spacer">By</span>
                            <dropdown-metric-tags
                                [namespace]="query.namespace"
                                [metric]="data.metric.name"
                                [selected]="data.metric.groupByTags"
                                (change)="setMetricGroupByTags(data.metric.id, $event)"></dropdown-metric-tags>
                        </div>
                    </div>
                    <!-- custom function loop -->
                    <div class="metric-row-data custom-function" *ngFor="let fx of data.metric.functions">
                        <div class="custom-function-wrapper">
                            <metric-function [metricId]="data.metric.id" [fx]="fx" (fxOut)="functionUpdate($event)" (fxDel)="functionDelete($event)"></metric-function>
                        </div>
                    </div>
                    <!-- custom function icon [ ALWAYS LAST ] -->
                    <div class="metric-row-data add-function"
                        [matMenuTriggerFor]="functionSelectionMenu"
                        [matMenuTriggerData]="{metric: data.metric}"
                        (click)="functionMenuOpened($event, i)"
                        (menuClosed)="functionMenuClosed($event)">
                        <button mat-flat-button color="primary">
                            <mat-icon svgIcon="function_icon"></mat-icon>
                            <div class="mat-select-arrow-wrapper">
                                <div class="mat-select-arrow"></div>
                            </div>
                        </button> 
                    </div>
                </td>
            </ng-container>

            <!-- SPECIAL CELL - Add Metric -->
            <ng-container matColumnDef="add-metric">
                <td mat-cell *matCellDef="let metric" [colSpan]="metricTableDisplayColumns.length">
                    <div style="display: flex; align-items: center; width: 100%; height: 100%;">
                        <div class="metric-row-data metric-index is-adding" *ngIf="isAddMetricProgress">
                            <button mat-flat-button>
                                <span class="label">
                                    <span>m</span>
                                </span>
                                <span class="mat-select-arrow-wrapper">
                                    <div class="mat-select-arrow" style="opacity: 0"></div>
                                </span>
                            </button>
                        </div>
                        <div class="metric-row-data metric-name is-adding" *ngIf="isAddMetricProgress">
                            <metric-autocomplete
                                [focus]="isAddMetricProgress"
                                [multiple]="true"
                                [namespace]="query.namespace"
                                [filters]="query.filters"
                                (metricOutput)="updateMetric($event, null);"
                                (blur)="isAddMetricProgress = false"></metric-autocomplete>
                        </div>
                    </div>
                </td>
            </ng-container>

            <!-- SPECIAL CELL - Add Expression -->
            <ng-container matColumnDef="add-expression">
                <td mat-cell *matCellDef="let metric" [colSpan]="metricTableDisplayColumns.length">
                    <div style="display: flex; align-items: center; width: 100%; height: 100%;">
                        <div class="metric-row-data metric-index is-adding" *ngIf="isAddExpressionProgress">
                            <button mat-flat-button>
                                <span class="label">
                                    <span>exp</span>
                                </span>
                                <span class="mat-select-arrow-wrapper">
                                    <div class="mat-select-arrow" style="opacity: 0"></div>
                                </span>
                            </button>
                        </div>
                        <div class="metric-row-data expression is-adding" *ngIf="isAddExpressionProgress">
                            <mat-form-field class="expression-input-field" appearance="outline" color="primary" floatLabel="never" >
                                <input matInput placeholder="e.g. m1 + m2"  formControlName="-1" (blur)="updateExpression(-1, $event)" (keyup.enter)="updateExpression(-1, $event)" autocomplete="off">
                                <mat-error *ngIf="fg.controls['-1'].errors && fg.controls['-1'].errors.invalid">
                                    Invalid Expression.
                                </mat-error>
                            </mat-form-field>
                        </div>
                    </div>
                </td>
            </ng-container>
            
            <!-- main headers [hidden by css] -->
            <tr mat-header-row *matHeaderRowDef="metricTableDisplayColumns"></tr>

            <!-- DEFAULT DATA ROW -->
            <tr mat-row
                *matRowDef="let row; columns: metricTableDisplayColumns;"
                class="metric-query-item"
                [ngClass]="{'metric-type': row.type === 'metric', 'expression-type': row.type === 'expression'}"></tr>
            <!-- SPECIAL ROW - add metric -->
            <tr mat-row
                *matRowDef="let row; columns: ['add-metric']; when: checkAddMetricRow"
                class="add-query-item"
                [ngClass]="{'is-hidden': !isAddMetricProgress}"
                [@addQueryItem]="isAddMetricProgress ? 'expanded' : 'collapsed'"
                style="overflow: hidden"></tr>
            <!-- SPECIAL ROW - add expression -->
            <tr mat-row
                *matRowDef="let row; columns: ['add-expression']; when: checkAddExpressionRow"
                class="add-query-item"
                [ngClass]="{'is-hidden': !isAddExpressionProgress}"
                [@addQueryItem]="isAddExpressionProgress ? 'expanded' : 'collapsed'"
                style="overflow: hidden"></tr>

        </table>

        <!-- ADD EXPRESSION - ENDS -->
    </div>
    
</div>
<div class="metric-action-buttons" *ngIf="query.namespace || query.metrics.length || query.filters.length">
    <button mat-button color="primary" *ngIf="!isAddMetricProgress || !query.metrics.length " (click)="addQueryItemProgress('metric')">
        <mat-icon fontSet="denali" fontIcon="d-add"></mat-icon>
        <span>Metric</span>
    </button>
    <button mat-button color="primary" *ngIf="query.metrics.length && !this.isAddExpressionProgress" (click)="editExpression(-1)" [disabled]="query.metrics.length === 0">
            <mat-icon fontSet="denali" fontIcon="d-add"></mat-icon>
            <span>Expression</span>
    </button>
</div>
<!-- METRIC MENU -->
<mat-menu class="metric-action-cdk-menu" #metricActionMenu="matMenu" hasBackdrop="true">
    <ng-template matMenuContent let-metric="metric">
        <!-- conditional button -->
        <button mat-menu-item *ngIf="canDisableMetrics" (click)="toggleMetric(metric.id)">
            <mat-icon fontSet="denali" [fontIcon]="metric.settings.visual.visible ? 'd-eye-close' : 'd-eye-open'"></mat-icon>
            <span>{{metric.settings.visual.visible ? 'Disable' : 'Enable'}}</span>
        </button>
        <button mat-menu-item (click)="cloneMetric(metric)">
            <mat-icon fontSet="denali" fontIcon="d-duplicate"></mat-icon>
            <span>Clone</span>
        </button>
        <button mat-menu-item [disabled]="!canDeleteMetric(metric.id)" (click)="deleteMetric(metric.id)">
            <mat-icon fontSet="denali" fontIcon="d-trash"></mat-icon>
            <span>Delete</span>
        </button>
    </ng-template>
</mat-menu>
<!-- TAG FILTER MENU -->
<mat-menu class="tag-filters-menu-wrapper" yPosition="below" #tagFilterMenu="matMenu" >
    <div class="filter" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" *ngIf="query.namespace">
        <inline-filter-editor [namespace]="query.namespace" [metrics]="query.metrics" [filters]="query.filters" (filterOutput)="updateFilters($event);" ></inline-filter-editor>
    </div>
</mat-menu>
<!-- FUNCTION MENU-->
<mat-menu class="function-selection-cdk-menu" #functionSelectionMenu="matMenu">
    <ng-template matMenuContent let-metric="metric">
        <div class="function-selection-wrapper" style="width: 300px; height: 200px;">
            <div class="function-categories">
                <mat-nav-list>
                    <a mat-list-item 
                        [ngClass]="{'is-active': i === selectedFunctionCategoryIndex}"
                        *ngFor="let category of functionCategories; let i = index;"
                        (click)="$event.stopPropagation(); selectFunctionCategory($event, i)">
                        <span>{{ category.label }}</span>
                        <mat-icon fontSet="denali" fontIcon="d-arrowhead-right"></mat-icon>
                    </a>
                </mat-nav-list>
            </div>
            <div class="function-category-items">
                <mat-nav-list *ngIf="selectedFunctionCategoryIndex >= 0">
                    <a mat-list-item *ngFor="let catFunction of functionCategories[selectedFunctionCategoryIndex].functions; let j = index;" (click)="addFunction(catFunction, metric.id)">
                        <span>{{ catFunction.label }}</span>
                    </a>
                </mat-nav-list>
            </div>
        </div>
    </ng-template>
</mat-menu>